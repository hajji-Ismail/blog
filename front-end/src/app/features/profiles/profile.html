<!-- Profile Container -->
<div *ngIf="!loading() && profile()" class="container py-4">
  <!-- Toast -->
  <div *ngIf="toastMessage()" class="profile-toast"
    [ngClass]="toastType() === 'success' ? 'toast-success' : 'toast-error'">
    {{ toastMessage() }}
  </div>

  <!-- Profile Header -->
  <div class="card profile-header shadow-sm mb-4">
    <div class="card-body d-flex align-items-center gap-3">
      <img [src]="getProfileImage(profile()!.profileImage)" class="rounded-circle border" width="80" height="80" />
      <div class="flex-grow-1">
        <h5 class="mb-1">{{ profile()!.username }}</h5>
        <div class="d-flex gap-3 text-muted small">
          <span><strong>{{ profile()!.followers }}</strong> Followers</span>
          <span><strong>{{ profile()!.following }}</strong> Following</span>
        </div>
      </div>

      <div *ngIf="!profile()!.profile" class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" (click)="onFollow(profile()!.username)">
          {{ profile()!.isFollowing ? 'Unfollow' : 'Follow' }}
        </button>
        <button class="btn btn-outline-danger btn-sm" (click)="openReportUser()">Report User</button>
      </div>
    </div>
  </div>

  <!-- No posts message -->
  <div *ngIf="profile()!.post.length === 0" class="text-center text-muted py-4">No posts yet</div>

  <!-- Posts -->
  <div *ngFor="let post of profile()!.post" class="card mb-3 shadow-sm post-card">
    <div class="card-body">
      <!-- Post Header -->
      <div class="d-flex align-items-center gap-2 mb-2">
        <img [src]="getProfileImage(post.profileImageUrl)" class="rounded-circle" width="32" height="32" />
        <div>
          <strong>{{ post.username }}</strong><br />
          <small class="text-muted">{{ post.createdAt | date:'short' }}</small>
        </div>
      </div>

      <h6 class="mb-1">{{ post.title }}</h6>
      <p class="mb-2">{{ post.content }}</p>

      <div *ngIf="post.medias.length" class="media-grid mb-3">
        <img *ngFor="let m of post.medias" [src]="m" class="img-fluid rounded" />
      </div>

      <!-- Post Actions -->
      <div class="d-flex align-items-center gap-3 border-top pt-2 post-actions">
        <button class="btn btn-link p-0 d-flex align-items-center gap-1" [class.reacted]="post.reacted"
          (click)="onReact(post)">
          <i class="bi bi-heart-fill"></i>
          <span>{{ post.reactionCount }}</span>
        </button>

        <button class="btn btn-link p-0 d-flex align-items-center gap-1" (click)="toggleComments(post)">
          <i class="bi bi-chat-left-text-fill"></i>
          <span>{{ post.commentCount }}</span>
        </button>

        <span class="ms-auto" *ngIf="!profile()!.profile">
          <button class="btn btn-sm btn-outline-danger" (click)="openReportPost(post)">Report Post</button>
        </span>
      </div>

      <!-- Comment Input -->
      <div class="d-flex gap-2 mt-2">
        <input type="text" class="form-control" placeholder="Write a comment..." [ngModel]="commentDraft()[post.id]"
          (ngModelChange)="updateCommentDraft(post.id, $event)" (keyup.enter)="onComment(post)" />
        <button class="btn btn-primary btn-sm" (click)="onComment(post)">Send</button>
      </div>

      <!-- Comments -->
      <div *ngIf="post.display" class="comments border-top mt-3 pt-3">
        <div *ngIf="post.comments.length === 0" class="text-muted small">No comments yet.</div>

        <div *ngFor="let comment of post.comments" class="d-flex gap-2 mb-2">
          <img [src]="getProfileImage(comment.profileImageUrl)" class="rounded-circle" width="28" height="28" />
          <div class="comment-bubble">
            <div class="d-flex align-items-center gap-2">
              <strong>{{ comment.username || 'Anonymous' }}</strong>
              <small class="text-muted">{{ comment.createdAt | date:'short' }}</small>
            </div>
            <div>{{ comment.content }}</div>
          </div>
        </div>
      </div>

      <!-- Edit/Delete buttons if it's the user's profile -->
      <div class="mt-3 d-flex gap-2" *ngIf="profile()!.profile">
        <button class="btn btn-sm btn-warning" (click)="openEdit(post)">Edit</button>
        <button class="btn btn-sm btn-danger" (click)="openDelete(post)">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Post Modal -->
<div *ngIf="editingPost()" class="overlay">
  <div class="modal-card">
    <h5 class="mb-3">Edit Post</h5>

    <label class="small mb-1">Title</label>
    <input [ngModel]="editTitle()" (ngModelChange)="editTitle.set($event)" class="form-control mb-2" />

    <label class="small mb-1">Content</label>
    <textarea [ngModel]="editContent()" (ngModelChange)="editContent.set($event)" class="form-control mb-3"
      rows="4"></textarea>

    <div class="mb-2">
      <label class="small d-block">Current images</label>
      <div class="media-grid mb-2">
        <img *ngFor="let m of editingPost()!.medias" [src]="m" class="img-fluid rounded" />
      </div>
    </div>

    <div class="mb-2">
      <label class="small">Replace images</label>
      <input type="file" class="form-control" multiple accept="image/*" (change)="onEditFilesChange($event)" />
      <small class="text-muted">Selecting new images replaces existing ones.</small>
    </div>

    <div *ngIf="editMediaPreview().length" class="mb-3">
      <label class="small d-block">Preview</label>
      <div class="media-grid">
        <img *ngFor="let preview of editMediaPreview()" [src]="preview" class="img-fluid rounded" />
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-secondary btn-sm" (click)="cancelEdit()">Cancel</button>
      <button class="btn btn-primary btn-sm" (click)="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Delete Post Modal -->
<div *ngIf="deletingPost()" class="overlay">
  <div class="modal-card">
    <h5>Delete Post</h5>
    <p class="mb-3">Are you sure you want to delete <strong>{{ deletingPost()!.title }}</strong>?</p>
    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-secondary btn-sm" (click)="closeDeleteModal()">Cancel</button>
      <button class="btn btn-danger btn-sm" (click)="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- Report Modal -->
<div *ngIf="reportMode()" class="overlay">
  <div class="modal-card">
    <h5 class="mb-2">{{ reportMode() === 'post' ? 'Report Post' : 'Report User' }}</h5>
    <p class="small text-muted mb-2" *ngIf="reportMode() === 'post'">Target: {{ reportingPost()?.username }}'s post</p>
    <p class="small text-muted mb-2" *ngIf="reportMode() === 'user'">Target: {{ profile()!.username }}</p>

    <textarea [ngModel]="reportReason()" (ngModelChange)="reportReason.set($event)" class="form-control mb-3" rows="4"
      placeholder="Describe the issue"></textarea>

    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-secondary btn-sm" (click)="closeReportModal()">Cancel</button>
      <button class="btn btn-danger btn-sm" (click)="submitReport()">Submit Report</button>
    </div>
  </div>
</div>